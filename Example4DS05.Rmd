---
title: "Did Dave's guitar hurt United Airlines' stock?"
author: "by Leshun Xu"
date: "May 1, 2019"
output:
  html_document: 
published: no
status: processed
tags: R forecast
draft: no
---

[United Breaks Guitars](https://www.youtube.com/watch?v=GTgZfCltMm8), a video, 
was uploaded to YouTube on July 6, 2009, and viewed 19,154,186 times by May 1, 2019. The author of this video is Dave Carroll, a  Canadian musician. His guitar was broken during a trip on United Airlines in 2008. After fruitless negotiations with the airline, he decided to write a song and create a video about his experience.
(For more details of this story, please refer to 
[United Breaks Guitars](https://en.wikipedia.org/wiki/United_Breaks_Guitars) on wikipidia, and another video
[*Dave Carroll: Lessons from "United Breaks Guitars"*](https://www.youtube.com/watch?v=_Hd8XI42i2M)
on YouTube.)

[*The Sunday Times*](https://web.archive.org/web/20100531204013/http://www.timesonline.co.uk/tol/comment/columnists/chris_ayres/article6722407.ece),
the largest-selling British national newspaper, reported on July 22, 2009, that this video caused United Airlines' stock price to plunge by 10 per cent just four days after the video was launched.
By referring to [Yahoo Finance data](https://finance.yahoo.com/quote/UAL/history?ltr=1),
it is tastelessly stated on Wikipedia [website](https://en.wikipedia.org/wiki/United_Breaks_Guitars): "In fact, UAL opened at \$3.31 on July 6, 2009 and dipped to an intra-day low \$3.07 (-7.25%) on July 10, but traded as high as $6.00 (+81.27%) four weeks later on August 6".

In this example, I am going to use Bayesian structural time-series models (in the CausalImpact R package) to examine the impacts of the video on United Airlines' stock (UAL). For more details of Bayesian structural time-series models and the package, please refer to the slide
[*Design of Experiments in R*](https://www.r-project.org/conferences/useR-2011/TalkSlides/Invited/Gromping-Design_of_Experiments.pdf) of the invited talk at [The R User Conference 2011](https://www.r-project.org/conferences/useR-2011/) by [Ulrike Groemping](https://prof.beuth-hochschule.de/groemping/?L=1), and the [paper](https://ai.google/research/pubs/pub41854) published in 2015.

In order to get some reference information for the trend of the UAL stock price, I introduce the [Nasdaq index](https://finance.yahoo.com/quote/INDEX/history?p=INDEX&.tsrc=fin-srch)
and four other airline companies' stocks:
[Southwest Airlines Co.](https://finance.yahoo.com/quote/LUV/history?p=LUV&.tsrc=fin-srch) (LUV),
[Delta Air Lines, Inc.](https://finance.yahoo.com/quote/DAL/history?p=DAL&.tsrc=fin-srch) (DAL),
[JetBlue Airways Corporation](https://finance.yahoo.com/quote/JBLU/history?p=JBLU&.tsrc=fin-srch) (JBLU)
and
[American Airlines Group Inc.](https://finance.yahoo.com/quote/AAL/history?p=AAL&.tsrc=fin-srch) (AAL).
All of them are treated as the predictor variables in CausalImpact package.
(All the stocks data I used in this example are from 
[Yahoo Finance](https://finance.yahoo.com/).)



## First glance at the data

We choose a subeset of 86 days from the data, i.e. 80 days before Jul 6 in 2009 and 5 days after that day.
The solid black line in each graph stands for the UAL stock price. As we can see, these two praphs imply there existed some factors on Jul 6 in 2009 (i.e. something that happened on the day) negatively impacted the UAL stock price in the following 5 days.
  
```{r setup, include=FALSE}
suppressMessages(library(CausalImpact, warn.conflicts = FALSE))
```

```{r, eval=TRUE, echo=FALSE, message=FALSE, warning=FALSE}
ual <- read.csv("UAL.csv")
luv <- read.csv("LUV.csv")
dal <- read.csv("DAL.csv")
jblu <- read.csv("JBLU.csv")
nas <- read.csv("INDEX.csv")
aal <- read.csv("AAL.csv")
y <- ual$Open
x1 <- luv$Open
x2 <- dal$Open
x3 <- jblu$Open
x4 <- aal$Open
x5 <- nas$Open
gdata0 <- cbind(y, x1, x2, x3, x4, x5)

gday <- which(ual$Date=="2009-07-06")

nb <- 80

na <- 5
nr <- (gday-nb):(gday+na)
gdata <- gdata0[nr,]

matplot(gdata, type = "l")

pre.period <- c(1, nb-1)
post.period <- c(nb, nb+na+1)
impact <- CausalImpact(gdata, pre.period, post.period)
plot(impact)
```

## Historical perspective on the impacts

In the following table, the **Days before** column lists the number of days before July 6 in 2009, which are then introduced to the data set as the pre-period in CausalImpact function. The **n days after** columns show the Absolute Effects for the next n days after July 6 in 2009, where n=5, 10, 20, 40. 
The decimals outside the brackets are the Absolute Effects, while the numbers inside the brackets are probabilities that show the significance of the effect.

An overview of the result in the table shows that the more historical data involved is, the less significant the effect to the following days.

```{r, eval=TRUE, echo=FALSE, message=FALSE, warning=FALSE}
days.before <- c(60, 80, 100, 110, 120, 160, 180)
days.after <- c(5, 10, 20, 40)
impacts <- data.frame(matrix(ncol = 4, nrow = 0))
names(impacts) <- c("before","after","AbsEffect","Probability")

n <- length(days.before)
m <- length(days.after)
t <-1
for ( i in 1:n) {
  for (j in 1:m) {
    nb <- days.before[i]
    na <- days.after[j]
    nr <- (gday-nb):(gday+na)
    gdata <- gdata0[nr,]
    pre.period <- c(1, nb-1)
    post.period <- c(nb, nb+na+1)
    impact <- CausalImpact(gdata, pre.period, post.period)
    impacts[t,] <- c(nb, na, round(c(impact$summary$AbsEffect[1], impact$summary$p[1]), 2))
    t <- t+1
  }
}

```

Days before | 5 days later | 10 days later | 20 days later | 40 days later
---------|------|---------|------ | ------
`r impacts[1,1]` | `r impacts[1,3]` (`r impacts[1,4]`) | `r impacts[2,3]` (`r impacts[2,4]`)  |  `r impacts[3,3]` (`r impacts[3,4]`)   |  `r impacts[4,3]` (`r impacts[4,4]`)  
`r impacts[5,1]` | `r impacts[5,3]` (`r impacts[5,4]`) | `r impacts[6,3]` (`r impacts[6,4]`)  |  `r impacts[7,3]` (`r impacts[7,4]`)   |  `r impacts[8,3]` (`r impacts[8,4]`)  
`r impacts[9,1]` | `r impacts[9,3]` (`r impacts[9,4]`) | `r impacts[10,3]` (`r impacts[10,4]`)  |  `r impacts[11,3]` (`r impacts[11,4]`)   |  `r impacts[12,3]` (`r impacts[12,4]`)  
`r impacts[13,1]` | `r impacts[13,3]` (`r impacts[13,4]`) | `r impacts[14,3]` (`r impacts[14,4]`)  |  `r impacts[15,3]` (`r impacts[15,4]`)   |  `r impacts[16,3]` (`r impacts[16,4]`)  
`r impacts[17,1]` | `r impacts[17,3]` (`r impacts[17,4]`) | `r impacts[18,3]` (`r impacts[18,4]`)  |  `r impacts[19,3]` (`r impacts[19,4]`)   |  `r impacts[20,3]` (`r impacts[20,4]`)  
`r impacts[21,1]` | `r impacts[21,3]` (`r impacts[21,4]`) | `r impacts[22,3]` (`r impacts[22,4]`)  |  `r impacts[23,3]` (`r impacts[23,4]`)   |  `r impacts[24,3]` (`r impacts[24,4]`)  
`r impacts[25,1]` | `r impacts[25,3]` (`r impacts[25,4]`) | `r impacts[26,3]` (`r impacts[26,4]`)  |  `r impacts[27,3]` (`r impacts[27,4]`)   |  `r impacts[28,3]` (`r impacts[28,4]`)  



## The day of July 6, 2009

Since there are many things that happened on July 6 in 2009, but also many which happens on every normal day, we are going to examine whether the behaviour of the UAL stock's price is abnormal in the sense of Absolute Effects.

By using the historical stock data from Jan 1 in 2008 to Dec 31 in 2009, we check the impact for the next 5 days (and 40 days) on each day, including July 6 2009, with 80 days before that day.

```{r, eval=TRUE, echo=FALSE, message=FALSE, warning=FALSE}
gdays <- c(81:(nrow(gdata0)-5))
n <- length(gdays)

impacts2 <- data.frame(matrix(ncol = 2, nrow = 0))
names(impacts2) <- c("AbsEffect","Probability")
t <- 1
nb <- 80
na <- 5
for (i in 1:n) {
  gday <- gdays[i]
  nr <- (gday-nb):(gday+na)
  gdata <- gdata0[nr,]
  pre.period <- c(1, nb-1)
  post.period <- c(nb, nb+na+1)
  impact <- CausalImpact(gdata, pre.period, post.period)
  impacts2[t,] <- c(impact$summary$AbsEffect[1], impact$summary$p[1])
  t <- t+1
}

m1 <- round(min(impacts2$AbsEffect),0); m2 <- ceiling(max(impacts2$AbsEffect))
breaks=seq(m1,m2, length.out = 100)

cols <- breaks
brk <- impacts[9,3]-0.05
cols[which(breaks<= brk)] <- "gold"
cols[which(breaks> brk)] <- "white"

hist(impacts2$AbsEffect, breaks=breaks, col = cols, main = "Distribution of Absolute Effects for the next 5 days", xlab = "Absolute Effect", probability = TRUE)

abline(v=impacts[9,3], col = "red", lwd=2, lty=2)

pp <- nrow(impacts2[which(impacts2$AbsEffect<=impacts[9,3]),])/nrow(impacts2)
pp1 <- round(pp*100,2)

```


```{r, eval=TRUE, echo=FALSE, message=FALSE, warning=FALSE}
nb <- 80
na <- 40
gdays <- c(81:(nrow(gdata0)-na))
n <- length(gdays)

impacts2 <- data.frame(matrix(ncol = 2, nrow = 0))
names(impacts2) <- c("AbsEffect","Probability")
t <- 1
for (i in 1:n) {
  gday <- gdays[i]
  nr <- (gday-nb):(gday+na)
  gdata <- gdata0[nr,]
  pre.period <- c(1, nb-1)
  post.period <- c(nb, nb+na+1)
  impact <- CausalImpact(gdata, pre.period, post.period)
  impacts2[t,] <- c(impact$summary$AbsEffect[1], impact$summary$p[1])
  t <- t+1
}

m1 <- round(min(impacts2$AbsEffect),0); m2 <- ceiling(max(impacts2$AbsEffect))
breaks=seq(m1,m2, length.out = 100)

cols <- breaks
brk <- impacts[12,3]
cols[which(breaks<= brk)] <- "white"
cols[which(breaks> brk)] <- "gold"

hist(impacts2$AbsEffect, breaks=breaks, col = cols, main = "Distribution of Absolute Effects for the next 40 days", xlab = "Absolute Effect", probability = TRUE)
abline(v=impacts[12,3], col = "red", lwd=2, lty=2)

pp <- nrow(impacts2[which(impacts2$AbsEffect>impacts[12,3]),])/nrow(impacts2)
pp2 <- round(pp*100,2)

```

In the above figures, the red line is the Absolute Effect of the day Jul 6 in 2009. Relative to the red line, the yellow part is the tail. The proportions of the tails to all effects are  `r pp1`% for the "next 5 days", and  `r pp2`%  for the "next 40 days".
Both effects are not far from the normal effects for each day, i.e. they belong to the effects from normal days.

Therefore, based on the model in the CausalImpact package, (although we do not know the specific number,) no matter how many factors affected it, July 6 in 2009 was just a normal day for the UAL stock.

